-- ===================================
-- SCRIPT SQL - SISTEMA DE IMOBILIÁRIA
-- Prefixo: RM98047_97648
-- ===================================

-- ===================================
-- TABELA: IMOVEL
-- ===================================

-- Criar tabela de imóveis
CREATE TABLE RM98047_97648_IMOVEL (
    ID NUMBER(10) NOT NULL,
    TITULO VARCHAR2(100) NOT NULL,
    DESCRICAO VARCHAR2(500) NOT NULL,
    TIPO_IMOVEL VARCHAR2(20) NOT NULL,
    FINALIDADE VARCHAR2(20) NOT NULL,
    VALOR_VENDA NUMBER(12,2) NOT NULL,
    VALOR_LOCACAO NUMBER(10,2) NOT NULL,
    ENDERECO VARCHAR2(200) NOT NULL,
    BAIRRO VARCHAR2(50) NOT NULL,
    CIDADE VARCHAR2(50) NOT NULL,
    ESTADO VARCHAR2(2) NOT NULL,
    CEP VARCHAR2(8) NOT NULL,
    QUARTOS NUMBER(3) DEFAULT 0,
    BANHEIROS NUMBER(3) DEFAULT 0,
    VAGAS NUMBER(3) DEFAULT 0,
    AREA_TOTAL NUMBER(10,2) DEFAULT 0,
    AREA_CONSTRUIDA NUMBER(10,2) DEFAULT 0,
    PROPRIETARIO VARCHAR2(100),
    TELEFONE_PROPRIETARIO VARCHAR2(15),
    STATUS VARCHAR2(20) DEFAULT 'Disponivel' NOT NULL,
    ATIVO NUMBER(1) DEFAULT 1 NOT NULL,
    DATA_CADASTRO DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_RM98047_97648_IMOVEL PRIMARY KEY (ID),
    CONSTRAINT CK_RM98047_97648_IMOVEL_TIPO CHECK (TIPO_IMOVEL IN ('Casa', 'Apartamento', 'Comercial', 'Terreno', 'Chacara', 'Galpao')),
    CONSTRAINT CK_RM98047_97648_IMOVEL_FINAL CHECK (FINALIDADE IN ('Venda', 'Locacao', 'Ambos')),
    CONSTRAINT CK_RM98047_97648_IMOVEL_STATUS CHECK (STATUS IN ('Disponivel', 'Ocupado', 'Manutencao')),
    CONSTRAINT CK_RM98047_97648_IMOVEL_ATIVO CHECK (ATIVO IN (0, 1))
);

-- Criar sequência para ID do imóvel
CREATE SEQUENCE SEQ_RM98047_97648_IMOVEL
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Criar trigger para auto increment do ID
CREATE OR REPLACE TRIGGER TRG_RM98047_97648_IMOVEL_ID
    BEFORE INSERT ON RM98047_97648_IMOVEL
    FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := SEQ_RM98047_97648_IMOVEL.NEXTVAL;
    END IF;
END;
/

-- ===================================
-- TABELA: CONTRATO
-- ===================================

-- Criar tabela de contratos
CREATE TABLE RM98047_97648_CONTRATO (
    ID NUMBER(10) NOT NULL,
    IMOVEL_ID NUMBER(10) NOT NULL,
    CLIENTE_ID NUMBER(10) NOT NULL,
    TIPO_CONTRATO VARCHAR2(20) NOT NULL,
    NUMERO_CONTRATO VARCHAR2(30) NOT NULL,
    VALOR NUMBER(12,2) NOT NULL,
    DATA_INICIO DATE NOT NULL,
    DATA_FIM DATE,
    DURACAO_MESES NUMBER(5),
    STATUS VARCHAR2(20) DEFAULT 'Ativo' NOT NULL,
    OBSERVACOES VARCHAR2(500),
    DATA_CADASTRO DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_RM98047_97648_CONTRATO PRIMARY KEY (ID),
    CONSTRAINT FK_RM98047_97648_CONTR_IMOV FOREIGN KEY (IMOVEL_ID) REFERENCES RM98047_97648_IMOVEL(ID),
    CONSTRAINT FK_RM98047_97648_CONTR_CLI FOREIGN KEY (CLIENTE_ID) REFERENCES RM98047_97648_CLIENTE(ID),
    CONSTRAINT UK_RM98047_97648_CONTR_NUM UNIQUE (NUMERO_CONTRATO),
    CONSTRAINT CK_RM98047_97648_CONTR_TIPO CHECK (TIPO_CONTRATO IN ('Venda', 'Locacao')),
    CONSTRAINT CK_RM98047_97648_CONTR_STAT CHECK (STATUS IN ('Ativo', 'Encerrado', 'Cancelado'))
);

-- Criar sequência para ID do contrato
CREATE SEQUENCE SEQ_RM98047_97648_CONTRATO
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Criar trigger para auto increment do ID
CREATE OR REPLACE TRIGGER TRG_RM98047_97648_CONTRATO_ID
    BEFORE INSERT ON RM98047_97648_CONTRATO
    FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := SEQ_RM98047_97648_CONTRATO.NEXTVAL;
    END IF;
END;
/

-- ===================================
-- TABELA: VISITA
-- ===================================

-- Criar tabela de visitas
CREATE TABLE RM98047_97648_VISITA (
    ID NUMBER(10) NOT NULL,
    IMOVEL_ID NUMBER(10) NOT NULL,
    CLIENTE_ID NUMBER(10) NOT NULL,
    DATA_VISITA DATE NOT NULL,
    HORA_INICIO INTERVAL DAY TO SECOND NOT NULL,
    HORA_FIM INTERVAL DAY TO SECOND NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'Agendada' NOT NULL,
    NOME_INTERESSADO VARCHAR2(100),
    TELEFONE_INTERESSADO VARCHAR2(15),
    EMAIL_INTERESSADO VARCHAR2(100),
    OBSERVACOES VARCHAR2(500),
    DATA_CADASTRO DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_RM98047_97648_VISITA PRIMARY KEY (ID),
    CONSTRAINT FK_RM98047_97648_VISIT_IMOV FOREIGN KEY (IMOVEL_ID) REFERENCES RM98047_97648_IMOVEL(ID),
    CONSTRAINT FK_RM98047_97648_VISIT_CLI FOREIGN KEY (CLIENTE_ID) REFERENCES RM98047_97648_CLIENTE(ID),
    CONSTRAINT CK_RM98047_97648_VISIT_STAT CHECK (STATUS IN ('Agendada', 'Confirmada', 'Realizada', 'Cancelada'))
);

-- Criar sequência para ID da visita
CREATE SEQUENCE SEQ_RM98047_97648_VISITA
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Criar trigger para auto increment do ID
CREATE OR REPLACE TRIGGER TRG_RM98047_97648_VISITA_ID
    BEFORE INSERT ON RM98047_97648_VISITA
    FOR EACH ROW
BEGIN
    IF :NEW.ID IS NULL THEN
        :NEW.ID := SEQ_RM98047_97648_VISITA.NEXTVAL;
    END IF;
END;
/

-- ===================================
-- INSERIR DADOS DE EXEMPLO
-- ===================================

-- Inserir imóveis
INSERT INTO RM98047_97648_IMOVEL (TITULO, DESCRICAO, TIPO_IMOVEL, FINALIDADE, VALOR_VENDA, VALOR_LOCACAO, ENDERECO, BAIRRO, CIDADE, ESTADO, CEP, QUARTOS, BANHEIROS, VAGAS, AREA_TOTAL, AREA_CONSTRUIDA, PROPRIETARIO, TELEFONE_PROPRIETARIO, STATUS) VALUES
('Apartamento Mobiliado 3 Quartos', 'Lindo apartamento mobiliado com 3 quartos, 2 banheiros e 2 vagas. Localização privilegiada.', 'Apartamento', 'Locacao', 0, 3500.00, 'Rua das Flores, 123', 'Jardins', 'São Paulo', 'SP', '01234567', 3, 2, 2, 120.50, 110.00, 'José Silva', '(11) 99999-1111', 'Disponivel');

INSERT INTO RM98047_97648_IMOVEL (TITULO, DESCRICAO, TIPO_IMOVEL, FINALIDADE, VALOR_VENDA, VALOR_LOCACAO, ENDERECO, BAIRRO, CIDADE, ESTADO, CEP, QUARTOS, BANHEIROS, VAGAS, AREA_TOTAL, AREA_CONSTRUIDA, PROPRIETARIO, TELEFONE_PROPRIETARIO, STATUS) VALUES
('Casa 4 Quartos com Piscina', 'Casa ampla com 4 quartos, piscina, churrasqueira e jardim. Ótima para famílias.', 'Casa', 'Venda', 850000.00, 0, 'Av. Principal, 456', 'Alto da Boa Vista', 'Rio de Janeiro', 'RJ', '20531000', 4, 3, 3, 350.00, 280.00, 'Maria Santos', '(21) 98888-2222', 'Disponivel');

INSERT INTO RM98047_97648_IMOVEL (TITULO, DESCRICAO, TIPO_IMOVEL, FINALIDADE, VALOR_VENDA, VALOR_LOCACAO, ENDERECO, BAIRRO, CIDADE, ESTADO, CEP, QUARTOS, BANHEIROS, VAGAS, AREA_TOTAL, AREA_CONSTRUIDA, PROPRIETARIO, TELEFONE_PROPRIETARIO, STATUS) VALUES
('Sala Comercial Centro', 'Sala comercial no centro da cidade, próximo a bancos e comércio.', 'Comercial', 'Ambos', 450000.00, 2500.00, 'Rua do Comércio, 789', 'Centro', 'Belo Horizonte', 'MG', '30110000', 0, 2, 2, 80.00, 80.00, 'Pedro Costa', '(31) 97777-3333', 'Disponivel');

INSERT INTO RM98047_97648_IMOVEL (TITULO, DESCRICAO, TIPO_IMOVEL, FINALIDADE, VALOR_VENDA, VALOR_LOCACAO, ENDERECO, BAIRRO, CIDADE, ESTADO, CEP, QUARTOS, BANHEIROS, VAGAS, AREA_TOTAL, AREA_CONSTRUIDA, PROPRIETARIO, TELEFONE_PROPRIETARIO, STATUS) VALUES
('Chácara com 5000m²', 'Chácara com área de 5000m², casa sede, pomar e lago. Ideal para lazer.', 'Chacara', 'Venda', 650000.00, 0, 'Estrada Rural, Km 15', 'Zona Rural', 'Campinas', 'SP', '13090000', 3, 2, 4, 5000.00, 180.00, 'Ana Oliveira', '(19) 96666-4444', 'Disponivel');

INSERT INTO RM98047_97648_IMOVEL (TITULO, DESCRICAO, TIPO_IMOVEL, FINALIDADE, VALOR_VENDA, VALOR_LOCACAO, ENDERECO, BAIRRO, CIDADE, ESTADO, CEP, QUARTOS, BANHEIROS, VAGAS, AREA_TOTAL, AREA_CONSTRUIDA, PROPRIETARIO, TELEFONE_PROPRIETARIO, STATUS) VALUES
('Apartamento Studio Novo', 'Studio novo, moderno e bem localizado. Perfeito para solteiros.', 'Apartamento', 'Locacao', 0, 1800.00, 'Rua Moderna, 321', 'Pinheiros', 'São Paulo', 'SP', '05422000', 1, 1, 1, 40.00, 38.00, 'Carlos Lima', '(11) 95555-5555', 'Disponivel');

-- Inserir contratos (usando clientes já existentes - IDs 1, 2, 3)
INSERT INTO RM98047_97648_CONTRATO (IMOVEL_ID, CLIENTE_ID, TIPO_CONTRATO, NUMERO_CONTRATO, VALOR, DATA_INICIO, DATA_FIM, DURACAO_MESES, STATUS, OBSERVACOES) VALUES
(1, 1, 'Locacao', 'LOC-2025-001', 3500.00, TO_DATE('2025-01-01', 'YYYY-MM-DD'), TO_DATE('2025-12-31', 'YYYY-MM-DD'), 12, 'Ativo', 'Contrato de locação residencial por 12 meses');

INSERT INTO RM98047_97648_CONTRATO (IMOVEL_ID, CLIENTE_ID, TIPO_CONTRATO, NUMERO_CONTRATO, VALOR, DATA_INICIO, DATA_FIM, DURACAO_MESES, STATUS, OBSERVACOES) VALUES
(2, 2, 'Venda', 'VEN-2025-001', 850000.00, TO_DATE('2025-02-15', 'YYYY-MM-DD'), NULL, NULL, 'Ativo', 'Venda à vista com escritura em andamento');

-- Inserir visitas agendadas
INSERT INTO RM98047_97648_VISITA (IMOVEL_ID, CLIENTE_ID, DATA_VISITA, HORA_INICIO, HORA_FIM, STATUS, NOME_INTERESSADO, TELEFONE_INTERESSADO, EMAIL_INTERESSADO, OBSERVACOES) VALUES
(3, 1, TO_DATE('2025-10-15', 'YYYY-MM-DD'), INTERVAL '09:00:00' HOUR TO SECOND, INTERVAL '10:00:00' HOUR TO SECOND, 'Agendada', 'Roberto Almeida', '(11) 94444-6666', 'roberto@email.com', 'Cliente interessado em sala comercial');

INSERT INTO RM98047_97648_VISITA (IMOVEL_ID, CLIENTE_ID, DATA_VISITA, HORA_INICIO, HORA_FIM, STATUS, NOME_INTERESSADO, TELEFONE_INTERESSADO, EMAIL_INTERESSADO, OBSERVACOES) VALUES
(4, 2, TO_DATE('2025-10-16', 'YYYY-MM-DD'), INTERVAL '14:00:00' HOUR TO SECOND, INTERVAL '15:30:00' HOUR TO SECOND, 'Confirmada', 'Fernanda Costa', '(19) 93333-7777', 'fernanda@email.com', 'Família interessada na chácara');

INSERT INTO RM98047_97648_VISITA (IMOVEL_ID, CLIENTE_ID, DATA_VISITA, HORA_INICIO, HORA_FIM, STATUS, NOME_INTERESSADO, TELEFONE_INTERESSADO, EMAIL_INTERESSADO, OBSERVACOES) VALUES
(5, 3, TO_DATE('2025-10-17', 'YYYY-MM-DD'), INTERVAL '10:00:00' HOUR TO SECOND, INTERVAL '11:00:00' HOUR TO SECOND, 'Agendada', 'Lucas Pereira', '(11) 92222-8888', 'lucas@email.com', 'Interessado no studio');

-- Commit das alterações
COMMIT;

-- ===================================
-- CONSULTAS ÚTEIS
-- ===================================

-- Ver todos os imóveis
SELECT * FROM RM98047_97648_IMOVEL ORDER BY ID;

-- Ver imóveis disponíveis
SELECT * FROM RM98047_97648_IMOVEL WHERE STATUS = 'Disponivel' AND ATIVO = 1 ORDER BY ID;

-- Ver todos os contratos
SELECT c.*, i.TITULO AS IMOVEL, cl.NOME AS CLIENTE
FROM RM98047_97648_CONTRATO c
JOIN RM98047_97648_IMOVEL i ON c.IMOVEL_ID = i.ID
JOIN RM98047_97648_CLIENTE cl ON c.CLIENTE_ID = cl.ID
ORDER BY c.ID;

-- Ver contratos ativos
SELECT c.*, i.TITULO AS IMOVEL, cl.NOME AS CLIENTE
FROM RM98047_97648_CONTRATO c
JOIN RM98047_97648_IMOVEL i ON c.IMOVEL_ID = i.ID
JOIN RM98047_97648_CLIENTE cl ON c.CLIENTE_ID = cl.ID
WHERE c.STATUS = 'Ativo'
ORDER BY c.ID;

-- Ver todas as visitas
SELECT v.*, i.TITULO AS IMOVEL, cl.NOME AS CLIENTE
FROM RM98047_97648_VISITA v
JOIN RM98047_97648_IMOVEL i ON v.IMOVEL_ID = i.ID
JOIN RM98047_97648_CLIENTE cl ON v.CLIENTE_ID = cl.ID
ORDER BY v.DATA_VISITA, v.HORA_INICIO;

-- Ver visitas agendadas (futuras)
SELECT v.*, i.TITULO AS IMOVEL, cl.NOME AS CLIENTE
FROM RM98047_97648_VISITA v
JOIN RM98047_97648_IMOVEL i ON v.IMOVEL_ID = i.ID
JOIN RM98047_97648_CLIENTE cl ON v.CLIENTE_ID = cl.ID
WHERE v.DATA_VISITA >= TRUNC(SYSDATE)
AND v.STATUS IN ('Agendada', 'Confirmada')
ORDER BY v.DATA_VISITA, v.HORA_INICIO;

-- Estatísticas
SELECT 
    (SELECT COUNT(*) FROM RM98047_97648_IMOVEL WHERE ATIVO = 1) AS TOTAL_IMOVEIS,
    (SELECT COUNT(*) FROM RM98047_97648_IMOVEL WHERE STATUS = 'Disponivel' AND ATIVO = 1) AS IMOVEIS_DISPONIVEIS,
    (SELECT COUNT(*) FROM RM98047_97648_CONTRATO WHERE STATUS = 'Ativo') AS CONTRATOS_ATIVOS,
    (SELECT COUNT(*) FROM RM98047_97648_VISITA WHERE DATA_VISITA >= TRUNC(SYSDATE) AND STATUS IN ('Agendada', 'Confirmada')) AS VISITAS_FUTURAS
FROM DUAL;

-- ===================================
-- SCRIPTS DE LIMPEZA (OPCIONAL)
-- ===================================

-- Limpar dados
-- DELETE FROM RM98047_97648_VISITA;
-- DELETE FROM RM98047_97648_CONTRATO;
-- DELETE FROM RM98047_97648_IMOVEL;
-- COMMIT;

-- Dropar tabelas
-- DROP TABLE RM98047_97648_VISITA CASCADE CONSTRAINTS;
-- DROP TABLE RM98047_97648_CONTRATO CASCADE CONSTRAINTS;
-- DROP TABLE RM98047_97648_IMOVEL CASCADE CONSTRAINTS;
-- DROP SEQUENCE SEQ_RM98047_97648_VISITA;
-- DROP SEQUENCE SEQ_RM98047_97648_CONTRATO;
-- DROP SEQUENCE SEQ_RM98047_97648_IMOVEL;
